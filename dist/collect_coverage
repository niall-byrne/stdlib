#!/bin/bash

# stdlib distributable coverage collector (requires kcov)
# $1: the target folder to collect coverage from

set -eo pipefail

TEST_RUNNER="${TEST_RUNNER-"t"}"

main() {
  [[ -d coverage ]] && rm -r coverage

  kcov \
    --include-pattern="${1}" \
    --exclude-pattern=tests,testing \
    --exclude-line=KCOV_EXCLUDE_LINE \
    --exclude-region=KCOV_EXCLUDE_BEGIN:KCOV_EXCLUDE_END \
    --limits 75,100 \
    coverage "${TEST_RUNNER}" "${1}"

  if ! { grep percent_covered "coverage/$(basename "${TEST_RUNNER}")/coverage.json" | grep -v 100; } then
   echo "Coverage SUCCEEDED"
   return 0
  fi

  echo "Coverage FAILED"
  return 127
}

main "${@}"
